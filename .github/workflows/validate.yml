name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff check
        run: uv run ruff check .

      - name: Run ruff format check
        run: uv run ruff format --check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run pytest
        run: uv run pytest tests/ -v

  ttl-syntax:
    name: Validate TTL Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rapper (RDF parser)
        run: sudo apt-get update && sudo apt-get install -y raptor2-utils

      - name: Validate ontology files
        run: |
          for file in ontologies/*.ttl; do
            echo "Validating $file..."
            rapper -i turtle -c "$file" || exit 1
          done

      - name: Validate shape files
        run: |
          for file in shapes/*.ttl; do
            echo "Validating $file..."
            rapper -i turtle -c "$file" || exit 1
          done

      - name: Validate data product files
        run: |
          for file in data/products/*.ttl; do
            echo "Validating $file..."
            rapper -i turtle -c "$file" || exit 1
          done

      - name: Validate vocabulary files
        run: |
          for file in data/vocab/*.ttl; do
            echo "Validating $file..."
            rapper -i turtle -c "$file" || exit 1
          done

      - name: Validate test files
        run: |
          for file in tests/valid/*.ttl tests/invalid/*.ttl; do
            echo "Validating $file..."
            rapper -i turtle -c "$file" || exit 1
          done

  shacl:
    name: SHACL Validation
    runs-on: ubuntu-latest
    services:
      graphdb:
        image: ontotext/graphdb:10.8.0
        ports:
          - 7200:7200
        options: >-
          --health-cmd "curl -f http://localhost:7200/rest/repositories || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Wait for GraphDB
        run: |
          echo "Waiting for GraphDB to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:7200/rest/repositories > /dev/null; then
              echo "GraphDB is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

      - name: Setup repository and load data
        run: make setup

      - name: Run SHACL validation tests
        run: make test-shacl
