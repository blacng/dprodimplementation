# Alerting rules for DPROD catalog

groups:
  - name: graphdb
    rules:
      # GraphDB is down
      - alert: GraphDBDown
        expr: up{job="graphdb"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "GraphDB is down"
          description: "GraphDB instance {{ $labels.instance }} has been down for more than 1 minute."

      # High heap usage
      - alert: GraphDBHighHeapUsage
        expr: graphdb_heap_used_bytes / graphdb_heap_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GraphDB heap usage is high"
          description: "GraphDB heap usage is above 90% on {{ $labels.instance }}."

      # Query latency high
      - alert: GraphDBSlowQueries
        expr: rate(graphdb_queries_duration_seconds_sum[5m]) / rate(graphdb_queries_duration_seconds_count[5m]) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GraphDB queries are slow"
          description: "Average query duration is above 2 seconds on {{ $labels.instance }}."

      # High error rate
      - alert: GraphDBHighErrorRate
        expr: rate(graphdb_queries_errors_total[5m]) / rate(graphdb_queries_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GraphDB error rate is high"
          description: "More than 5% of queries are failing on {{ $labels.instance }}."

  - name: dprod-catalog
    rules:
      # Repository size growing unexpectedly
      - alert: DPRODRepositorySizeAnomaly
        expr: delta(graphdb_repository_statements_total{repository="dprod-catalog"}[1h]) > 10000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "DPROD repository size changed significantly"
          description: "Repository size changed by more than 10,000 statements in the last hour."

      # No data products (possible data loss)
      - alert: DPRODNoDataProducts
        expr: graphdb_repository_statements_total{repository="dprod-catalog"} < 100
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "DPROD catalog appears empty"
          description: "The dprod-catalog repository has fewer than 100 statements. Possible data loss."
